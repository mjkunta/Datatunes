{
  "hash": "f5cadcc16acad016d1b7d8c06fc8c0f1",
  "result": {
    "markdown": "---\ntitle: \"Query MS SQL and PostgreSQL from R/Quarto\"\nformat: html\neditor: visual\ndate: 2023-11-27\ncategories: [R,Quarto, MS SQL, PostegreSQL]\ntitle-block-banner: false\n---\n\n\nI have been using Quarto in RStudio for a few months now and I am captivated by it's features. The ability to seamlessly execute SQL queries directly from SQL code chunks and saving results as R data frames is compelling. This connection is valuable when you want to leverage R's data manipulations capabilities especially the tidyverse packages. We will explore a few examples in the next blog.\n\nFor now, let's focus on establishing connections to and querying the following SQL databases:\n\n-   MS SQL Server\n-   PostegreSQL\n\n#### **Load the Required Libraries:**\n\nMy preferred approach needs installation of only two packages. That is: ODBC and DBI. Since I have already installed the two packages, I will go ahead and load them.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(odbc) # provides drivers to connect to different SQL dialects\nlibrary(DBI)  # provides functions to interact with the database\n\nlibrary(tidyverse) # for data manipulation\n```\n:::\n\n\n#### **Connect to MS SQL Server**\n\nI will begin by connecting to Microsoft SQL Server using the dbConnect function from the DBI package. This function allows for database user authentication and connection establishment. You will need to provide the Driver, Server, Database, UID, and PWD parameters to the dbConnect function. For MS SQL Server, the Server parameter corresponds to the Server name, UID corresponds to Login, and PWD corresponds to Password in the login details, as shown in the first screenshot below. To obtain the MS SQL Driver, navigate to the Drivers tab in the ODBC Data Sources window, as shown in the second screenshot. The driver name will depend on the MS SQL version you are using.\n\n![MS SQL Login](MS%20SQL%20login.png){fig-align=\"center\" width=\"522\"}\n\n![Drivers](drivers.png){fig-align=\"center\" width=\"510\"}\n\nAfter passing in the required parameters to **dbConnect**, I will save my connection as *mssql_con* as shown below. Having established the connection, we are ready to query our MS SQL database.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmssql_con <- DBI::dbConnect(drv = odbc::odbc(),\n                      Driver = \"SQL Server\",\n                      Server = \"DESKTOP-CKPR726\",\n                      Database = \"Employees\"\n                      #UID = \"user\",\n                      #PWD = \"password\"\n                      ) \n```\n:::\n\n\nOnce the above code runs, the connection will be established and it will be displayed in the connection pane of your RStudio. As you can see below, we have connected to Employees database, we can see the tables under it, and the column names under Employee_Info table.\n\n![](connection.png){fig-align=\"center\"}\n\n#### **Querying MS SQL Server**\n\nOf course we can query from an R code chunk as below using dbGetQuery(). But let's focus on how to do this froma sql code chunk.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nquery <- 'SELECT TOP 5 Full_Name, Age, Gender FROM Employee_Info'\n\nemployees_df <- DBI::dbGetQuery(mssql_con, query)\n```\n:::\n\n\nIn the SQL code chunk section, assign your connection variable to the connection parameter.\n\n![](mssql%20con.png){fig-align=\"left\"}\n\nAnd then run your query as below.\n\n\n::: {.cell}\n\n```{.sql .cell-code}\n\nSELECT\n         COALESCE(Gender, 'Employees') AS Gender\n        ,COALESCE(Country, 'Total') AS Country\n        ,COUNT(Full_Name) AS Employee_Counts\nFROM \n        Employee_Info AS EI\nLEFT JOIN\n        Job_Desc AS JD\n        ON EI.Emp_ID = JD.Emp_ID\nWHERE\n        Country <> 'Kenya'\nGROUP BY\n        ROLLUP (Gender, Country)\n\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 9 records\n\n|Gender    |Country       | Employee_Counts|\n|:---------|:-------------|---------------:|\n|Female    |Brazil        |              60|\n|Female    |China         |              98|\n|Female    |United States |             313|\n|Female    |Total         |             471|\n|Male      |Brazil        |              65|\n|Male      |China         |             102|\n|Male      |United States |             271|\n|Male      |Total         |             438|\n|Employees |Total         |             909|\n\n</div>\n:::\n\n\nYou'll want to save the output of your query into a df that you can interact with R.\n\nYou can achieve this by passing a variable name to the output.var option in the sql code chunk as shown below.\n\n![](output.var.png){fig-align=\"left\"}\n\nAnd then run your query. The query output will be saved as employee_gender_per_ctry and it will be one of the variables in your environment window in RStudio.\n\n\n::: {.cell output.var='employee_gender_per_ctry'}\n\n```{.sql .cell-code}\n\nSELECT\n         COALESCE(Gender, 'Employees in') AS Gender\n        ,COALESCE(Country, 'all countries') AS Country\n        ,COUNT(Full_Name) AS Employee_Counts\nFROM \n        Employee_Info AS EI\nLEFT JOIN\n        Job_Desc AS JD\n        ON EI.Emp_ID = JD.Emp_ID\nWHERE\n        Country <> 'Kenya'\nGROUP BY\n        CUBE (Gender, Country)\n        \n```\n:::\n\n\nHere is our stored query output.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nemployee_gender_per_ctry\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         Gender       Country Employee_Counts\n1        Female        Brazil              60\n2          Male        Brazil              65\n3  Employees in        Brazil             125\n4        Female         China              98\n5          Male         China             102\n6  Employees in         China             200\n7        Female United States             313\n8          Male United States             271\n9  Employees in United States             584\n10 Employees in all countries             909\n11       Female all countries             471\n12         Male all countries             438\n```\n:::\n:::\n\n\n#### **Connect to PostegreSQL**\n\nFor postgreSQL, you will follow the same procedure as we did with MS SQL and pass in the login details provided by your Database administrator. In my case, I'm the superuser ðŸ˜Ž. Since my database is hosted locally, my server will be localhost, UID = postgres and PWD = postgres. These are the defaults when you install postgreSQL. But I changed my PWD to maangi.\n\nThe most important thing will be knowing the driver to use. Accessing these details is slightly different from accessing the MS SQL driver. Follow the following steps:\n\n-   On you windows laptop, you click the windows key + R.\n\n-   On the window that pops up, type - **odbcad32.exe**\n\n    ![](postgre_drivers.png){width=\"501\"}\n\n-   Click ok and navigate to the Drivers tab and pick the appropriate driver name as shown below.\n\n    ![](postgresql_drivers.png){width=\"501\"}\n\nHaving passed in all the required parameters to **dbConnect**, I will proceed to create a connection variable called *postegresql_con*.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Establish the connection\npostgresql_con <- dbConnect(odbc::odbc(),\n Driver = \"PostgreSQL ODBC Driver(ANSI)\",\n Database = \"car_brands\",\n Server = \"localhost\",\n UID = \"postgres\",\n PWD = \"maangi\"\n)\n```\n:::\n\n\nOn running the above connection query, if you navigate to the connections pane in your RStudio, you will see that a connection has been establisted to postgresSQL.\n\n![](connection_pane.png){fig-align=\"left\"}\n\n#### **Querying PostgreSQL**\n\nSince we have established a connection, we can now query postgreSQL straight from a SQL code chunk in quarto as below.\n\n![](postgre_query.png)\n\n\n::: {.cell output.var='cars'}\n\n```{.sql .cell-code}\n\nSELECT * FROM cars\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncars\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   brand  model year\n1  Volvo  p1800 1968\n2    BMW     M1 1978\n3 Toyota Celica 1975\n```\n:::\n:::\n\n\nThere is a second approach that we can use to connect to postgreSQL. In this case, we will need to install and load the RPostgres package. Most of the parameters we pass in are similar except for port which we didn't provide in the first approach and driver which is not needed in this case.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load the required library\nlibrary(RPostgres)\n\n# Replace these values with your actual database credentials\n postgresql_con2 <- dbConnect(RPostgres::Postgres(),\n  dbname = \"car_brands\",\n  user = \"postgres\",\n  password = \"maangi\",\n  host = \"localhost\",\n  port = 5432  # The default PostgreSQL port is 5432\n)\n```\n:::\n\n\n#### **Disconnect**\n\nLastly, it's a good practice to disconnect from you database when you are done querying it to free up your laptop resources.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# disconnect from MS SQL\ndbDisconnect(mssql_con)\n\n# disconnect from MS SQL\ndbDisconnect(postgresql_con)\n\ndbDisconnect(postgresql_con2)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}